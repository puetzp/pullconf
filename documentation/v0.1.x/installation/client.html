<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"></meta>
    <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
    <link rel="stylesheet" href="/css/pico.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <script src="/js/htmx.min.js"></script>
    <title>Pullconf - Documentation</title>
  </head>
  <body>
    <div hx-get="/header.html" hx-trigger="load" hx-target="this" hx-swap="outerHTML"></div>
    <main class="container">
      <div hx-get="/v0.1.x/table-of-contents.html" hx-trigger="load" hx-target="this" hx-swap="outerHTML"></div>
      <div>
	<hgroup>
	  <p>Installation</p>
	  <h2>Client</h2>
	  <hr>
	</hgroup>
	<p>
	  The following steps guide you on how to install and configure the Pullconf client component <em>pullconf</em> on a client system.
	</p>
	<p>
	  Download and install the .deb package from GitHub:
	</p>
	<p>
	  <kbd>$ wget https://github.com/puetzp/pullconf/releases/download/v0.1.0/pullconf_0.1.0-1_amd64.deb</kbd>
	</p>
	<p>
	  <kbd>$ sudo dpkg -i pullconf_0.1.0_amd64.deb</kbd>
	</p>
	<p>
	  The installation script sets up a systemd service unit (<em>pullconf.service</em>), a timer unit (<em>pullconf.timer</em>) and a data directory. Check the service unit's status:
	</p>
	<p>
	  <kbd>$ sudo systemctl status pullconf.service</kbd>
	</p>
	<p>
	  As you may notice the unit is not enabled by the installation script, because it lacks an <code>[Install]</code> section. It is a static service unit that is activated by a scheduler and exits after the resource catalog has been applied. The timer unit from the package is used to execute the <em>pullconf.service</em> unit regularly. By default it is configured to trigger the service unit every five minutes.</p>
	<p>
	  <u>Optional</u>: Take a look at the timer unit:
	</p>
	<p>
	  <kbd>$ sudo systemctl cat pullconf.timer</kbd>
	</p>
	<p>
	  <u>Optional</u>: Adjust the <code>OnCalendar</code> expression or other settings by creating an override file:
	</p>
	<p>
	  <kbd>$ sudo systemctl edit pullconf.timer</kbd>
	</p>
	<p>
	  <u>Optional</u>: If you prefer a different scheduling method, disable the timer unit and configure the scheduler of your choice:
	</p>
	<p>
	  <kbd>$ sudo systemctl disable pullconf.timer</kbd>
	</p>
	<p>
	  If this is your first installation the service unit (<em>pullconf.service</em>) will likely be in the "failed" state after being triggered for the first time by the scheduler, because some mandatory configuration parameters need to be set up. Refer to the log at <code>/var/log/pullconf/pullconf.log</code> to see what might be missing to start the unit.
	</p>
	<p>As with the server component <em>pullconf</em> is configured via environment variables. As you can see in the systemd unit file the unit reads environment variables from <code>/etc/pullconf/environment</code> (the required format is documented <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html#EnvironmentFile=" target="_blank">here</a>). Refer to the following table for all available parameters.
	</p>
	<table id="environment-variables">
	  <thead>
	    <tr>
	      <th scope="col">Name</th>
	      <th scope="col">Description</th>
	      <th scope="col">Mandatory</th>
	      <th scope="col">Default</th>
	    </tr>
	  </thead>
	  <tbody>
	    <tr>
	      <td>PULLCONF_SERVER</td>
	      <td>The <em>pullconfd</em> host that <em>pullconf</em> should connect to, e.g. <code>pullconf.local</code></td>
	      <td>yes</td>
	      <td></td>
	    </tr>
	    <tr>
	      <td>PULLCONF_API_KEY</td>
	      <td>
		<p>The API key that <em>pullconf</em> uses to authenticate with <em>pullconfd</em>.</p>
		<p>This should be a random string. A suitable string can be generated by running <kbd>$ openssl rand -base64 32</kbd></p>
	      </td>
	      <td>yes</td>
	      <td></td>
	    </tr>
	    <tr>
	      <td>PULLCONF_CA_DIR</td>
	      <td>
		<p>If the TLS certificate of your <em>pullconfd</em> server is self-signed or signed by a custom CA, this variable must be set to a directory where a file containing the certificate is located, e.g. <code>/usr/local/share/ca-certificates</code></p>
		<p><em>pullconf</em> will read every file from this directory and load them into a certificate truststore that is used when connecting to <em>pullconfd</em>.</p>
	      </td>
	      <td>no</td>
	      <td></td>
	    </tr>
	    <tr>
	      <td>PULLCONF_LOG_FORMAT</td>
	      <td>
		<p><em>pullconf</em> uses structured logging. This variable determines the output format of the logs.</p>
		<p>
		  Valid values are:
		  <ul>
		    <li><code>logfmt</code></li>
		    <li><code>json</code></li>
		  </ul>
		</p>
	      </td>
	      <td>no</td>
	      <td><code>logfmt</code></td>
	    </tr>
	    <tr>
	      <td>LOG_LEVEL</td>
	      <td>
		<p>
		  This variable is read by the underlying logging library. Check their <a href="https://docs.rs/std-logger/latest/std_logger/index.html#setting-severity" target="_blank">documentation</a> for a complete overview of valid values.
		</p>
		<p>
		  Usually one of these will do:
		  <ul>
		    <li><code>error</code></li>
		    <li><code>warn</code></li>
		    <li><code>info</code></li>
		    <li><code>debug</code></li>
		    <li><code>trace</code></li>
		  </ul>
		</p>
	      </td>
	      <td>no</td>
	      <td><code>info</code></td>
	    </tr>
	  </tbody>
	</table>
	<p>
	  Once <em>pullconf.timer</em> triggers <em>pullconf.service</em> the updated values from <code>/env/pullconf/environment</code> will be used.
	</p>
	<p>
	  However <em>pullconf.service</em> will likely fail again. That is because <em>pullconf</em> tries to authenticate to <em>pullconfd</em> with a hostname and its API key. Both are still unknown to <em>pullconfd</em> as long as no client configuration file exists on the server side. Proceed to <a href="/v0.1.x/configuration/client.html">creating a client configuration file</a> in order to enable the connection from <em>pullconf</em> to <em>pullconfd</em>.
	</p>
      </div>
    </main>
  </body>
</html>
